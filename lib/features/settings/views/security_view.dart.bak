import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:go_router/go_router.dart';
import 'package:flutter_gen/gen_l10n/app_localizations.dart';
import '../../../design/tokens/index.dart';
import '../../../design/components/primitives/index.dart';
import '../../../services/biometric/biometric_service.dart';

class SecurityView extends ConsumerStatefulWidget {
  const SecurityView({super.key});

  @override
  ConsumerState<SecurityView> createState() => _SecurityViewState();
}

class _SecurityViewState extends ConsumerState<SecurityView> {
  bool _twoFactorEnabled = false;
  bool _transactionPinRequired = true;
  bool _loginNotifications = true;
  bool _newDeviceAlerts = true;

  @override
  Widget build(BuildContext context) {
    final l10n = AppLocalizations.of(context)!;

    return Scaffold(
      backgroundColor: AppColors.obsidian,
      appBar: AppBar(
        backgroundColor: Colors.transparent,
        title: AppText(
          l10n.security_title,
          variant: AppTextVariant.titleLarge,
          color: AppColors.textPrimary,
        ),
        leading: IconButton(
          icon: const Icon(Icons.arrow_back, color: AppColors.gold500),
          onPressed: () => context.pop(),
        ),
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(AppSpacing.md),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Security Score
            _buildSecurityScoreCard(),

            const SizedBox(height: AppSpacing.xxl),

            // Authentication Section
            AppText(
              l10n.security_authentication,
              variant: AppTextVariant.titleMedium,
              color: AppColors.textPrimary,
            ),
            const SizedBox(height: AppSpacing.md),
            _buildSecurityOption(
              l10n: l10n,
              icon: Icons.lock_outline,
              title: l10n.security_changePin,
              subtitle: l10n.security_changePinSubtitle,
              onTap: () => context.push('/settings/change-pin'),
            ),
            const SizedBox(height: AppSpacing.sm),
            _buildBiometricToggle(),
            const SizedBox(height: AppSpacing.sm),
            _buildToggleOption(
              l10n: l10n,
              icon: Icons.security,
              title: l10n.security_twoFactorAuth,
              subtitle: _twoFactorEnabled ? l10n.security_twoFactorEnabledSubtitle : l10n.security_twoFactorDisabledSubtitle,
              value: _twoFactorEnabled,
              onChanged: (value) => _handleTwoFactorToggle(value),
            ),

            const SizedBox(height: AppSpacing.xxl),

            // Transaction Security
            AppText(
              l10n.security_transactionSecurity,
              variant: AppTextVariant.titleMedium,
              color: AppColors.textPrimary,
            ),
            const SizedBox(height: AppSpacing.md),
            _buildToggleOption(
              l10n: l10n,
              icon: Icons.pin,
              title: l10n.security_requirePinForTransactions,
              subtitle: l10n.security_requirePinSubtitle,
              value: _transactionPinRequired,
              onChanged: (value) => setState(() => _transactionPinRequired = value),
            ),

            const SizedBox(height: AppSpacing.xxl),

            // Alerts Section
            AppText(
              l10n.security_alerts,
              variant: AppTextVariant.titleMedium,
              color: AppColors.textPrimary,
            ),
            const SizedBox(height: AppSpacing.md),
            _buildToggleOption(
              l10n: l10n,
              icon: Icons.login,
              title: l10n.security_loginNotifications,
              subtitle: l10n.security_loginNotificationsSubtitle,
              value: _loginNotifications,
              onChanged: (value) => setState(() => _loginNotifications = value),
            ),
            const SizedBox(height: AppSpacing.sm),
            _buildToggleOption(
              l10n: l10n,
              icon: Icons.devices,
              title: l10n.security_newDeviceAlerts,
              subtitle: l10n.security_newDeviceAlertsSubtitle,
              value: _newDeviceAlerts,
              onChanged: (value) => setState(() => _newDeviceAlerts = value),
            ),

            const SizedBox(height: AppSpacing.xxl),

            // Session Management
            AppText(
              l10n.security_sessions,
              variant: AppTextVariant.titleMedium,
              color: AppColors.textPrimary,
            ),
            const SizedBox(height: AppSpacing.md),
            _buildSecurityOption(
              l10n: l10n,
              icon: Icons.devices,
              title: l10n.security_devices,
              subtitle: l10n.security_devicesSubtitle,
              onTap: () => context.push('/settings/devices'),
            ),
            const SizedBox(height: AppSpacing.sm),
            _buildSecurityOption(
              l10n: l10n,
              icon: Icons.smartphone,
              title: l10n.security_activeSessions,
              subtitle: l10n.security_activeSessionsSubtitle,
              onTap: () => context.push('/settings/sessions'),
            ),
            const SizedBox(height: AppSpacing.sm),
            _buildSecurityOption(
              l10n: l10n,
              icon: Icons.logout,
              title: l10n.security_logoutAllDevices,
              subtitle: l10n.security_logoutAllDevicesSubtitle,
              onTap: () => _confirmLogoutAll(),
              isDanger: true,
            ),

            const SizedBox(height: AppSpacing.xxl),

            // Privacy
            AppText(
              l10n.security_privacy,
              variant: AppTextVariant.titleMedium,
              color: AppColors.textPrimary,
            ),
            const SizedBox(height: AppSpacing.md),
            _buildSecurityOption(
              l10n: l10n,
              icon: Icons.history,
              title: l10n.security_loginHistory,
              subtitle: l10n.security_loginHistorySubtitle,
              onTap: () => _showLoginHistory(),
            ),
            const SizedBox(height: AppSpacing.sm),
            _buildSecurityOption(
              l10n: l10n,
              icon: Icons.delete_forever,
              title: l10n.security_deleteAccount,
              subtitle: l10n.security_deleteAccountSubtitle,
              onTap: () => _confirmDeleteAccount(),
              isDanger: true,
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildSecurityScoreCard() {
    final score = _calculateSecurityScore();
    final scoreColor = score >= 80
        ? AppColors.successBase
        : (score >= 60 ? AppColors.warningBase : AppColors.errorBase);

    return AppCard(
      variant: AppCardVariant.elevated,
      child: Column(
        children: [
          Row(
            children: [
              SizedBox(
                width: 80,
                height: 80,
                child: Stack(
                  alignment: Alignment.center,
                  children: [
                    SizedBox(
                      width: 80,
                      height: 80,
                      child: CircularProgressIndicator(
                        value: score / 100,
                        strokeWidth: 8,
                        backgroundColor: AppColors.textSecondary.withValues(alpha: 0.2),
                        valueColor: AlwaysStoppedAnimation<Color>(scoreColor),
                      ),
                    ),
                    AppText(
                      '$score',
                      variant: AppTextVariant.headlineSmall,
                      color: scoreColor,
                    ),
                  ],
                ),
              ),
              const SizedBox(width: AppSpacing.lg),
              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    AppText(
                      l10n.security_scoreTitle,
                      variant: AppTextVariant.titleMedium,
                      color: AppColors.textPrimary,
                    ),
                    const SizedBox(height: AppSpacing.xxs),
                    AppText(
                      _getScoreDescription(score, l10n),
                      variant: AppTextVariant.bodySmall,
                      color: AppColors.textSecondary,
                    ),
                  ],
                ),
              ),
            ],
          ),
          if (score < 100) ...[
            const SizedBox(height: AppSpacing.lg),
            Divider(color: AppColors.textSecondary.withValues(alpha: 0.2)),
            const SizedBox(height: AppSpacing.md),
            Row(
              children: [
                const Icon(Icons.lightbulb_outline, color: AppColors.gold500, size: 20),
                const SizedBox(width: AppSpacing.sm),
                Expanded(
                  child: AppText(
                    _getScoreTip(score, l10n),
                    variant: AppTextVariant.bodySmall,
                    color: AppColors.textSecondary,
                  ),
                ),
              ],
            ),
          ],
        ],
      ),
    );
  }

  Widget _buildSecurityOption({
    required AppLocalizations l10n,
    required IconData icon,
    required String title,
    required String subtitle,
    required VoidCallback onTap,
    bool isDanger = false,
  }) {
    return InkWell(
      onTap: onTap,
      borderRadius: BorderRadius.circular(AppRadius.md),
      child: Padding(
        padding: const EdgeInsets.all(AppSpacing.md),
        child: Row(
          children: [
            Container(
              width: 44,
              height: 44,
              decoration: BoxDecoration(
                color: isDanger
                    ? AppColors.errorBase.withValues(alpha: 0.1)
                    : AppColors.slate,
                borderRadius: BorderRadius.circular(AppRadius.md),
              ),
              child: Icon(
                icon,
                color: isDanger ? AppColors.errorBase : AppColors.gold500,
                size: 22,
              ),
            ),
            const SizedBox(width: AppSpacing.md),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  AppText(
                    title,
                    variant: AppTextVariant.labelMedium,
                    color: isDanger ? AppColors.errorBase : AppColors.textPrimary,
                  ),
                  AppText(
                    subtitle,
                    variant: AppTextVariant.bodySmall,
                    color: AppColors.textSecondary,
                  ),
                ],
              ),
            ),
            Icon(
              Icons.chevron_right,
              color: isDanger ? AppColors.errorBase : AppColors.textSecondary,
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildToggleOption({
    required AppLocalizations l10n,
    required IconData icon,
    required String title,
    required String subtitle,
    required bool value,
    required ValueChanged<bool> onChanged,
  }) {
    return Padding(
      padding: const EdgeInsets.all(AppSpacing.md),
      child: Row(
        children: [
          Container(
            width: 44,
            height: 44,
            decoration: BoxDecoration(
              color: AppColors.slate,
              borderRadius: BorderRadius.circular(AppRadius.md),
            ),
            child: Icon(icon, color: AppColors.gold500, size: 22),
          ),
          const SizedBox(width: AppSpacing.md),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                AppText(
                  title,
                  variant: AppTextVariant.labelMedium,
                  color: AppColors.textPrimary,
                ),
                AppText(
                  subtitle,
                  variant: AppTextVariant.bodySmall,
                  color: AppColors.textSecondary,
                ),
              ],
            ),
          ),
          Switch(
            value: value,
            onChanged: onChanged,
            activeThumbColor: AppColors.gold500,
          ),
        ],
      ),
    );
  }

  Widget _buildBiometricToggle() {
    final l10n = AppLocalizations.of(context)!;
    final biometricAvailable = ref.watch(biometricAvailableProvider);
    final biometricEnabled = ref.watch(biometricEnabledProvider);

    return biometricAvailable.when(
      data: (available) {
        if (!available) {
          return _buildToggleOption(
            l10n: l10n,
            icon: Icons.fingerprint,
            title: l10n.security_biometricLogin,
            subtitle: l10n.security_biometricNotAvailable,
            value: false,
            onChanged: (_) {
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(
                  content: Text(l10n.security_biometricUnavailableMessage),
                  backgroundColor: AppColors.warningBase,
                ),
              );
            },
          );
        }

        return biometricEnabled.when(
          data: (enabled) => _buildToggleOption(
            l10n: l10n,
            icon: Icons.fingerprint,
            title: l10n.security_biometricLogin,
            subtitle: l10n.security_biometricSubtitle,
            value: enabled,
            onChanged: (value) async {
              final biometricService = ref.read(biometricServiceProvider);
              if (value) {
                final authenticated = await biometricService.authenticate(
                  reason: l10n.security_biometricVerifyReason,
                );
                if (authenticated) {
                  await biometricService.enableBiometric();
                  ref.invalidate(biometricEnabledProvider);
                }
              } else {
                await biometricService.disableBiometric();
                ref.invalidate(biometricEnabledProvider);
              }
            },
          ),
          loading: () => _buildToggleOption(
            l10n: l10n,
            icon: Icons.fingerprint,
            title: l10n.security_biometricLogin,
            subtitle: l10n.security_loading,
            value: false,
            onChanged: (_) {},
          ),
          error: (_, __) => _buildToggleOption(
            l10n: l10n,
            icon: Icons.fingerprint,
            title: l10n.security_biometricLogin,
            subtitle: l10n.security_errorLoadingState,
            value: false,
            onChanged: (_) {},
          ),
        );
      },
      loading: () => _buildToggleOption(
        l10n: l10n,
        icon: Icons.fingerprint,
        title: l10n.security_biometricLogin,
        subtitle: l10n.security_checkingAvailability,
        value: false,
        onChanged: (_) {},
      ),
      error: (_, __) => _buildToggleOption(
        l10n: l10n,
        icon: Icons.fingerprint,
        title: l10n.security_biometricLogin,
        subtitle: l10n.security_errorCheckingAvailability,
        value: false,
        onChanged: (_) {},
      ),
    );
  }

  int _calculateSecurityScore() {
    final biometricEnabled = ref.watch(biometricEnabledProvider);
    final biometricsOn = biometricEnabled.maybeWhen(
      data: (value) => value,
      orElse: () => false,
    );

    int score = 40; // Base score for having account
    if (biometricsOn) score += 20;
    if (_twoFactorEnabled) score += 25;
    if (_transactionPinRequired) score += 10;
    if (_loginNotifications) score += 5;
    return score.clamp(0, 100);
  }

  String _getScoreDescription(int score, AppLocalizations l10n) {
    if (score >= 90) return l10n.security_scoreExcellent;
    if (score >= 70) return l10n.security_scoreGood;
    if (score >= 50) return l10n.security_scoreModerate;
    return l10n.security_scoreLow;
  }

  String _getScoreTip(int score, AppLocalizations l10n) {
    final biometricEnabled = ref.watch(biometricEnabledProvider);
    final biometricsOn = biometricEnabled.maybeWhen(
      data: (value) => value,
      orElse: () => false,
    );

    if (!_twoFactorEnabled) return l10n.security_tipEnable2FA;
    if (!biometricsOn) return l10n.security_tipEnableBiometrics;
    if (!_transactionPinRequired) return l10n.security_tipRequirePin;
    return l10n.security_tipEnableNotifications;
  }

  void _handleTwoFactorToggle(bool value) {
    if (value) {
      _showTwoFactorSetup();
    } else {
      _confirmDisableTwoFactor();
    }
  }

  void _showTwoFactorSetup() {
    final l10n = AppLocalizations.of(context)!;

    showModalBottomSheet(
      context: context,
      backgroundColor: AppColors.slate,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(AppRadius.xl)),
      ),
      builder: (context) {
        return Padding(
          padding: const EdgeInsets.all(AppSpacing.xl),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Container(
                width: 80,
                height: 80,
                decoration: BoxDecoration(
                  color: AppColors.gold500.withValues(alpha: 0.1),
                  shape: BoxShape.circle,
                ),
                child: const Icon(Icons.security, color: AppColors.gold500, size: 40),
              ),
              const SizedBox(height: AppSpacing.lg),
              AppText(
                l10n.security_setup2FATitle,
                variant: AppTextVariant.titleMedium,
                color: AppColors.textPrimary,
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: AppSpacing.sm),
              AppText(
                l10n.security_setup2FAMessage,
                variant: AppTextVariant.bodyMedium,
                color: AppColors.textSecondary,
                textAlign: TextAlign.center,
              ),
              const SizedBox(height: AppSpacing.xl),
              AppButton(
                label: l10n.security_continueSetup,
                onPressed: () {
                  Navigator.pop(context);
                  setState(() => _twoFactorEnabled = true);
                  ScaffoldMessenger.of(context).showSnackBar(
                    SnackBar(
                      content: Text(l10n.security_2FAEnabledSuccess),
                      backgroundColor: AppColors.successBase,
                    ),
                  );
                },
                variant: AppButtonVariant.primary,
                isFullWidth: true,
              ),
              const SizedBox(height: AppSpacing.md),
              AppButton(
                label: l10n.action_cancel,
                onPressed: () => Navigator.pop(context),
                variant: AppButtonVariant.secondary,
                isFullWidth: true,
              ),
            ],
          ),
        );
      },
    );
  }

  void _confirmDisableTwoFactor() {
    showDialog(
      context: context,
      builder: (context) {
        return AlertDialog(
          backgroundColor: AppColors.slate,
          title: const AppText(
            'Disable 2FA?',
            variant: AppTextVariant.titleMedium,
            color: AppColors.textPrimary,
          ),
          content: const AppText(
            'This will make your account less secure. Are you sure?',
            variant: AppTextVariant.bodyMedium,
            color: AppColors.textSecondary,
          ),
          actions: [
            AppButton(
              label: 'Cancel',
              onPressed: () => Navigator.pop(context),
              variant: AppButtonVariant.ghost,
              size: AppButtonSize.small,
            ),
            AppButton(
              label: 'Disable',
              onPressed: () {
                Navigator.pop(context);
                setState(() => _twoFactorEnabled = false);
              },
              variant: AppButtonVariant.danger,
              size: AppButtonSize.small,
            ),
          ],
        );
      },
    );
  }


  void _confirmLogoutAll() {
    showDialog(
      context: context,
      builder: (context) {
        return AlertDialog(
          backgroundColor: AppColors.slate,
          title: const AppText(
            'Log Out All Devices?',
            variant: AppTextVariant.titleMedium,
            color: AppColors.textPrimary,
          ),
          content: const AppText(
            'You will be logged out from all other devices. You will need to log in again on those devices.',
            variant: AppTextVariant.bodyMedium,
            color: AppColors.textSecondary,
          ),
          actions: [
            AppButton(
              label: 'Cancel',
              onPressed: () => Navigator.pop(context),
              variant: AppButtonVariant.ghost,
              size: AppButtonSize.small,
            ),
            AppButton(
              label: 'Log Out All',
              onPressed: () {
                Navigator.pop(context);
                ScaffoldMessenger.of(context).showSnackBar(
                  const SnackBar(
                    content: Text('All other devices have been logged out'),
                    backgroundColor: AppColors.successBase,
                  ),
                );
              },
              variant: AppButtonVariant.danger,
              size: AppButtonSize.small,
            ),
          ],
        );
      },
    );
  }

  void _showLoginHistory() {
    final colors = context.colors;
    showModalBottomSheet(
      context: context,
      backgroundColor: colors.container,
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(AppRadius.xl)),
      ),
      isScrollControlled: true,
      builder: (context) {
        final colors = context.colors;
        return DraggableScrollableSheet(
          initialChildSize: 0.6,
          minChildSize: 0.4,
          maxChildSize: 0.9,
          expand: false,
          builder: (context, scrollController) => Padding(
            padding: const EdgeInsets.all(AppSpacing.xl),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const AppText(
                  'Login History',
                  variant: AppTextVariant.titleMedium,
                ),
                const SizedBox(height: AppSpacing.lg),
                Expanded(
                  child: ListView(
                    controller: scrollController,
                    children: [
                      _buildLoginHistoryItem(
                        colors: colors,
                        time: 'Today, 10:30 AM',
                        device: 'iPhone 15 Pro',
                        location: 'San Francisco, CA',
                        success: true,
                      ),
                      _buildLoginHistoryItem(
                        colors: colors,
                        time: 'Yesterday, 3:45 PM',
                        device: 'MacBook Pro',
                        location: 'San Francisco, CA',
                        success: true,
                      ),
                      _buildLoginHistoryItem(
                        colors: colors,
                        time: 'Yesterday, 9:12 AM',
                        device: 'Unknown Device',
                        location: 'New York, NY',
                        success: false,
                      ),
                      _buildLoginHistoryItem(
                        colors: colors,
                        time: 'Jan 20, 2:30 PM',
                        device: 'iPhone 15 Pro',
                        location: 'Los Angeles, CA',
                        success: true,
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
        );
      },
    );
  }

  Widget _buildLoginHistoryItem({
    required ThemeColors colors,
    required String time,
    required String device,
    required String location,
    required bool success,
  }) {
    return Padding(
      padding: const EdgeInsets.only(bottom: AppSpacing.md),
      child: AppCard(
        variant: AppCardVariant.subtle,
        child: Row(
          children: [
            Container(
              width: 40,
              height: 40,
              decoration: BoxDecoration(
                color: success
                    ? AppColors.successBase.withValues(alpha: 0.1)
                    : AppColors.errorBase.withValues(alpha: 0.1),
                shape: BoxShape.circle,
              ),
              child: Icon(
                success ? Icons.check : Icons.close,
                color: success ? AppColors.successBase : AppColors.errorBase,
                size: 20,
              ),
            ),
            const SizedBox(width: AppSpacing.md),
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  AppText(
                    device,
                    variant: AppTextVariant.labelMedium,
                  ),
                  AppText(
                    '$location - $time',
                    variant: AppTextVariant.bodySmall,
                    color: colors.textSecondary,
                  ),
                ],
              ),
            ),
            AppText(
              success ? 'Success' : 'Failed',
              variant: AppTextVariant.labelSmall,
              color: success ? AppColors.successBase : AppColors.errorBase,
            ),
          ],
        ),
      ),
    );
  }

  void _confirmDeleteAccount() {
    showDialog(
      context: context,
      builder: (context) {
        return AlertDialog(
          backgroundColor: AppColors.slate,
          title: const AppText(
            'Delete Account?',
            variant: AppTextVariant.titleMedium,
            color: AppColors.errorBase,
          ),
          content: const AppText(
            'This action is permanent and cannot be undone. All your data, transaction history, and funds will be lost.',
            variant: AppTextVariant.bodyMedium,
            color: AppColors.textSecondary,
          ),
          actions: [
            AppButton(
              label: 'Cancel',
              onPressed: () => Navigator.pop(context),
              variant: AppButtonVariant.ghost,
              size: AppButtonSize.small,
            ),
            AppButton(
              label: 'Delete',
              onPressed: () {
                Navigator.pop(context);
                // Would show another confirmation
              },
              variant: AppButtonVariant.danger,
              size: AppButtonSize.small,
            ),
          ],
        );
      },
    );
  }
}
